# シーケンス図

**最終更新日**: 2026年2月13日  
**対象リポジトリ**: repository-C（統合リポジトリ）

---

## 📋 概要

本資料は、`repository-C` プロジェクトに含まれる各サブモジュールの主要な処理フローをMermaid記法のシーケンス図として記載したものです。  
各APIリクエストの処理順序、データベース操作、レスポンス返却までの流れを視覚的に表現しています。

---

## 📦 repository-A: ユーザー登録API

### 1. ユーザー登録フロー（POST /api/users/register）

```mermaid
sequenceDiagram
    participant Client as クライアント
    participant API as API Server (Flask/Express)
    participant Validator as 入力検証
    participant DB as SQLite Database
    participant Hash as パスワードハッシュ化

    Client->>API: POST /api/users/register
    Note over Client,API: { username, email, password, passwordConfirm }
    
    API->>Validator: 入力検証開始
    Validator->>Validator: 必須項目チェック
    Validator->>Validator: メール形式チェック（正規表現）
    Validator->>Validator: パスワード長チェック（6文字以上）
    Validator->>Validator: パスワード一致チェック
    
    alt 検証エラー
        Validator-->>API: エラー情報
        API-->>Client: 400 Bad Request
    else 検証成功
        Validator-->>API: 検証OK
        
        API->>DB: ユーザー名重複チェック
        DB-->>API: 重複確認結果
        
        API->>DB: メール重複チェック
        DB-->>API: 重複確認結果
        
        alt 重複あり
            API-->>Client: 400 Bad Request (重複エラー)
        else 重複なし
            API->>Hash: パスワードハッシュ化
            Hash-->>API: ハッシュ値返却
            
            API->>DB: INSERT INTO users
            Note over API,DB: username, email, hashed_password, created_at
            DB-->>API: user_id, 登録完了
            
            API-->>Client: 201 Created
            Note over API,Client: { message, user }
        end
    end
```

### 2. ユーザー情報更新フロー（PATCH /api/users/<user_id>）

```mermaid
sequenceDiagram
    participant Client as クライアント
    participant API as API Server (Flask/Express)
    participant DB as SQLite Database

    Client->>API: PATCH /api/users/:id
    Note over Client,API: { username, email } (任意)
    
    API->>DB: SELECT * FROM users WHERE id = :id
    
    alt ユーザーが存在しない
        DB-->>API: 結果なし
        API-->>Client: 404 Not Found
    else ユーザーが存在
        DB-->>API: ユーザー情報返却
        
        API->>DB: UPDATE users SET ...
        Note over API,DB: username, email更新
        DB-->>API: 更新完了
        
        API->>DB: 更新後のユーザー情報取得
        DB-->>API: 更新済みユーザー情報
        
        API-->>Client: 200 OK
        Note over API,Client: { message, user }
    end
```

### 3. Flask実装のアーキテクチャフロー

```mermaid
sequenceDiagram
    participant Request as HTTPリクエスト
    participant Flask as Flask App
    participant Route as ルートハンドラ
    participant SQLAlchemy as SQLAlchemy ORM
    participant SQLite as SQLite (users.db)

    Request->>Flask: リクエスト受信
    Flask->>Route: ルーティング
    Route->>SQLAlchemy: ORM操作
    SQLAlchemy->>SQLite: SQL実行
    SQLite-->>SQLAlchemy: 結果返却
    SQLAlchemy-->>Route: Python オブジェクト
    Route-->>Flask: JSONレスポンス生成
    Flask-->>Request: HTTPレスポンス
```

### 4. Node.js実装のアーキテクチャフロー

```mermaid
sequenceDiagram
    participant Request as HTTPリクエスト
    participant Express as Express App
    participant Route as ルートハンドラ
    participant DB_Module as db.js
    participant SQLite as SQLite (users.db)

    Request->>Express: リクエスト受信
    Express->>Route: ルーティング
    Route->>DB_Module: DB関数呼び出し
    DB_Module->>SQLite: SQL実行（パラメータ化）
    SQLite-->>DB_Module: 結果返却
    DB_Module-->>Route: JavaScript オブジェクト
    Route-->>Express: JSONレスポンス生成
    Express-->>Request: HTTPレスポンス
```

---

## 📦 repository-B: FastAPI サーバー

### 1. Hello World（GET /hello）

```mermaid
sequenceDiagram
    participant Client as クライアント
    participant FastAPI as FastAPI Server

    Client->>FastAPI: GET /hello
    FastAPI-->>Client: 200 OK
    Note over FastAPI,Client: { "message": "HELLO" }
```

### 2. 数値加算（POST /add）

```mermaid
sequenceDiagram
    participant Client as クライアント
    participant FastAPI as FastAPI Server
    participant Validator as Pydanticバリデーション
    participant Logic as ビジネスロジック

    Client->>FastAPI: POST /add
    Note over Client,FastAPI: { "a": 5, "b": 3 }
    
    FastAPI->>Validator: リクエストボディ検証
    Validator->>Validator: int型チェック
    
    alt 検証エラー
        Validator-->>FastAPI: ValidationError
        FastAPI-->>Client: 422 Unprocessable Entity
    else 検証成功
        Validator-->>FastAPI: 検証OK
        FastAPI->>Logic: a + b 計算
        Logic-->>FastAPI: 結果: 8
        FastAPI-->>Client: 200 OK
        Note over FastAPI,Client: { "result": 8 }
    end
```

### 3. 文字列反転（POST /reverse）

```mermaid
sequenceDiagram
    participant Client as クライアント
    participant FastAPI as FastAPI Server
    participant Logic as ビジネスロジック

    Client->>FastAPI: POST /reverse
    Note over Client,FastAPI: { "text": "hello" }
    
    FastAPI->>Logic: text[::-1] 実行
    Logic-->>FastAPI: "olleh"
    
    FastAPI-->>Client: 200 OK
    Note over FastAPI,Client: { "reversed": "olleh" }
```

### 4. 文字列長（POST /length）

```mermaid
sequenceDiagram
    participant Client as クライアント
    participant FastAPI as FastAPI Server
    participant Logic as ビジネスロジック

    Client->>FastAPI: POST /length
    Note over Client,FastAPI: { "text": "FastAPI" }
    
    FastAPI->>Logic: len(text) 実行
    Logic-->>FastAPI: 7
    
    FastAPI-->>Client: 200 OK
    Note over FastAPI,Client: { "length": 7 }
```

---

## 🔄 システム全体フロー

### サブモジュール情報の自動統合フロー

```mermaid
sequenceDiagram
    participant SubA as repository-A (サブモジュール)
    participant SubB as repository-B (サブモジュール)
    participant Main as repository-C (統合リポジトリ)
    participant GHA as GitHub Actions
    participant Copilot as GitHub Copilot

    SubA->>SubA: コード変更・コミット
    SubA->>Main: webhook: repository_dispatch
    
    Main->>GHA: ワークフロートリガー
    GHA->>Main: git submodule update --remote
    
    GHA->>GHA: 変更検知
    
    alt 変更あり
        GHA->>Main: git commit & push
        GHA->>Copilot: Issue作成 (@copilot)
        Note over GHA,Copilot: 機能定義書・シーケンス図の自動更新依頼
        
        Copilot->>Main: サブモジュール内容解析
        Copilot->>Main: 機能定義書.md更新
        Copilot->>Main: シーケンス図.md更新
        Copilot->>Main: コミット・PR作成
    else 変更なし
        GHA->>GHA: 処理終了
    end
```

---

## 🔄 更新履歴

| 日付 | 変更内容 | AIモデル名 |
|------|---------|-----------|
| 2026-02-13 | 初版作成 | Claude Sonnet 4.5 |

---

## 📝 運用ルール

このドキュメントは、サブモジュールの変更に応じてGitHub Actions + GitHub Copilotにより自動更新されます。  
シーケンス図の追加・修正が必要な場合は、サブモジュール側のソースコードまたはコメントに処理フローを明記してください。

---

**最終更新日時（日本時間）**: 2026年2月13日 00:00:00

